---
platform: linux

image_resource:
  type: docker-image
  source: {repository: python, tag: 2-jessie}

inputs:
  - name: csmake-pull-requests

outputs:
  - name: test-results

run:
  path: /bin/bash
  args:
  - -exc
  - |
    virtualenv testrun
    . testrun/bin/activate
    pip install coverage
    pushd csmake-pull-requests
    if ./RUNTESTS.sh
    then
        echo "Gate Passed"
    else
        popd
        echo "Gate Failed"
        cat csmake-pull-requests/test-results/`ls -t test-results | head -n 1`
        exit 1
    fi
    mv csmake-pull-requests/test-results/* test-results

